document.addEventListener("DOMContentLoaded",init);const reservation={total_pay:"",rental_time:"",start_time:"",rental_date:""};let busyHours={};function init(){selectDate(),selectQuantityHours(),makeReservation(),isEditMode()}function isEditMode(){if(getUrlParams("edit")){const e=document.querySelector(".date");let t=document.querySelector(".quantity-hours").value.split("-");reservation.rental_date=e.value,reservation.total_pay=parseInt(t[0]*t[1]),reservation.rental_time=t[1],callApi(reservation.rental_date),console.log(reservation)}}function makeReservation(){document.querySelector(".button-reservation").addEventListener("click",(e=>{if(!validateData())return;getFieldId(),getUserId();saveReservation(createNewFormData())}))}function validateData(){const e=document.getElementById("closing_time").value,{rental_time:t,start_time:r}=reservation,n=parseInt(r.slice(0,3));for(let r=n;r<n+parseInt(t);r++){if(r>=parseInt(e))return void alert("elige una cantidad de horas menor");if(checkHours(busyHours,r<10?`0${r}:00:00`:`${r}:00:00`))return void alert("hay un cruce de horarios")}return!0}function createNewFormData(){const e=new FormData;for(let t in reservation)e.append(t,reservation[t]);return e}async function saveReservation(e){console.log(reservation);const t=getUrlParams("edit"),r=t?`http://localhost:3000/api/updateReservation?id=${t}`:"http://localhost:3000/api/saveReservation";try{response=await fetch(r,{method:"POST",body:e});const n=await response.json();if(console.log(n),!n.result)throw new Error("error inesperado");alert(t?"reserva editada correctamente":"reserva creada correctamente"),t?location.replace("http://localhost:3000/profile/my-reservations"):location.reload()}catch(e){alert("error inesperado intenta luego")}}function getUserId(){const e=document.querySelector("#user-id");reservation.user_id=e.value}function getFieldId(){reservation.field_id=getUrlParams("id")}function selectQuantityHours(){document.querySelector(".quantity-hours").addEventListener("input",(({target:e})=>{if(""==e.value)return reservation.total_pay="",reservation.rental_time="",void showReservationButton();let t=e.value.split("-");reservation.total_pay=parseInt(t[0]*t[1]),reservation.rental_time=t[1],showReservationButton()}))}function selectDate(){document.querySelector(".date").addEventListener("change",(({target:e})=>{let t=e.value;reservation.rental_date=t,reservation.start_time="",showReservationButton(),callApi(t)}))}async function callApi(e){const t=getUrlParams("id"),r=getUrlParams("edit");try{let n=`http://localhost:3000/api/getReservations?date=${e}&field=${t}`;r&&(n+=`&edit=${r}`);const o=await fetch(n);if(200==!o.ok)throw new Error("error desconocido");busyHours=await o.json(),renderViewHours(busyHours)}catch(e){console.log(e),alert("ocurrio un error en el servidor, intenta luego")}}function renderViewHours(e){console.log(e);const t=document.querySelector(".free-hours-container"),r=document.createElement("H2");r.classList.add("title-hours"),t.innerHTML="";const n=getHoursOpeningClose();console.log(n);let o=0;for(;o<n.length;){if(checkHours(e,n[o])){const e=document.createElement("BUTTON");e.disabled=!0,e.classList.add("button-disabled"),e.innerText=`${n[o]}`,e.id=n[o],t.appendChild(e),o++;continue}const r=document.createElement("BUTTON");r.innerText=`${n[o]}`,r.id=n[o],r.addEventListener("click",selectHour),t.appendChild(r),o++}document.querySelector(".title-hours")||t.insertAdjacentElement("beforebegin",r),0===t.childElementCount?document.querySelector(".title-hours").innerText="no hay horas disponibles":document.querySelector(".title-hours").innerText="estas son las horas disponibles de la sucursal"}function checkHours(e,t){let r=t.slice(0,2);for(let t in e){let n=t.slice(0,2),o=e[t].slice(0,2);if(parseInt(r)>=n&&parseInt(r)<o)return!0}return!1}function getHoursOpeningClose(){let e=document.getElementById("opening_hours").value,t=document.getElementById("closing_time").value;if(getFullDate()===reservation.rental_date){e=(new Date).getHours()+1}const r=[];for(let n=parseInt(e);n<parseInt(t);n++){let e=n<10?`0${n}:00:00`:`${n}:00:00`;r.push(e)}return r}function getFullDate(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function selectHour({target:e}){reservation.start_time=e.id;const t=document.querySelector(".select-hour");t?e.id==t.id?(t.classList.remove("select-hour"),reservation.start_time=""):(t.classList.remove("select-hour"),e.classList.add("select-hour")):e.classList.add("select-hour"),showReservationButton()}function getUrlParams(e){const t=window.location.search;return new URLSearchParams(t).get(e)}function createTemplateMessage(e){const t=document.createElement("DIV");t.innerHTML=`\n     <h2>${e}</h2>\n  `,fieldsContainer.appendChild(t)}function showReservationButton(){console.log(reservation);const e=document.querySelector(".button-reservation");for(let t in reservation)if(!reservation[t])return void e.classList.add("hidden");e.classList.remove("hidden")}